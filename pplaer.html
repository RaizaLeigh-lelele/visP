<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flowchart Planner</title>
<style>
    :root {
        --primary-color: #1E90FF;
        --header-bg: var(--primary-color);
        --panel-bg: #fff;
        --button-bg: var(--primary-color);
        --button-text: #fff;
        --task-border: var(--primary-color);
        --progress-fill: var(--primary-color);
        --bg-color: #f0f4f8;
        --text-color: #333;
    }

    body {
        margin:0;
        font-family:Arial,sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
    }

    header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:10px 20px;
        background: var(--header-bg);
        color:#fff;
    }

    .nav-left a {
        color:#fff;
        text-decoration:none;
        margin-right:15px;
        font-weight:bold;
    }

    .nav-right {
        display:flex;
        gap:10px;
        align-items:center;
    }

    main {
        padding:20px;
    }

    .panel {
        background: var(--panel-bg);
        border-radius:8px;
        padding:15px;
        box-shadow:0 2px 5px rgba(0,0,0,0.1);
        margin-bottom:20px;
    }

    input,button {
        padding:5px 10px;
        border-radius:5px;
        border:none;
        margin:5px 0;
    }

    button {
        cursor:pointer;
        background: var(--button-bg);
        color: var(--button-text);
        font-weight:bold;
    }

    .progress-bar {
        position:relative;
        width:100%;
        background:#ddd;
        border-radius:8px;
        overflow:hidden;
        margin-bottom:10px;
    }

    .progress-bar-fill {
        height:25px;
        background: var(--progress-fill);
        width:0%;
        border-radius:8px;
        transition:width 0.5s;
    }

    #plannerBoard {
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:20px;
        margin-top:15px;
    }

    .flow-row {
        display:flex;
        gap:30px;
        align-items:center;
        position:relative;
    }

    .task-node {
        padding:10px 15px;
        border:2px solid var(--primary-color);
        border-radius:8px;
        background: var(--panel-bg);
        text-align:center;
        min-width:120px;
        position:relative;
        cursor:pointer;
    }

    .task-node.done {
        opacity:0.5;
    }

    .arrow {
        width:50px;
        height:2px;
        background:var(--primary-color);
        position:absolute;
        top:50%;
        left:100%;
    }

    .focus-display {
        margin-top:10px;
        font-weight:bold;
        font-size:1.1em;
    }
</style>
</head>
<body>
    <header>
        <div class="nav-left">
            <a href="#">Home</a>
            <a href="#">Tasks</a>
        </div>
        <div class="nav-right">
            <button id="musicToggle">ðŸŽµ Music On</button>
            <input type="color" id="colorPicker" value="#1E90FF" title="Change UI Color">
        </div>
    </header>

    <main>
        <div class="panel">
            <h2>Add Task</h2>
            <input type="text" id="taskName" placeholder="Task Name">
            <input type="number" id="taskTime" placeholder="Time (hrs)" min="0.5" step="0.5">
            <input type="number" id="taskDifficulty" placeholder="Difficulty 1-10" min="1" max="10">
            <input type="datetime-local" id="taskDue">
            <button onclick="addTask()">Add Task</button>
        </div>

        <div class="panel">
            <h2>Progress</h2>
            <div class="progress-bar"><div id="progressFill" class="progress-bar-fill"></div></div>
        </div>

        <div class="panel">
            <h2>Focus Mode</h2>
            <input type="number" id="focusTime" placeholder="Minutes (max 60)" min="1" max="60">
            <button onclick="startFocusMode()">Start Focus</button>
            <button onclick="stopFocusMode()">Stop Focus</button>
            <div class="focus-display" id="focusDisplay">No session running</div>

            <h2>Planner Board</h2>
            <div id="plannerBoard"></div>
            </div>
</main>

<audio id="bgMusic" loop>
    <source src="h.mp3" type="audio/mpeg">
</audio>

<script>
    let tasks=[];
    const plannerBoard=document.getElementById('plannerBoard');
    const progressFill=document.getElementById('progressFill');
    const musicToggle=document.getElementById('musicToggle');
    const bgMusic=document.getElementById('bgMusic');
    const focusDisplay=document.getElementById('focusDisplay');
    const focusTimeInput=document.getElementById('focusTime');

    let isPlaying=false;
    let focusInterval=null;
    let focusEndTime=null;
    let focusStartTime=null;

    musicToggle.addEventListener('click',()=>{
        if(isPlaying){bgMusic.pause();musicToggle.textContent='ðŸŽµ Music Off';}
        else{bgMusic.play();musicToggle.textContent='ðŸŽµ Music On';}
        isPlaying=!isPlaying;
    });

    document.getElementById('colorPicker').addEventListener('input', e => {
        const c = e.target.value;

        document.documentElement.style.setProperty('--primary-color', c);

        document.documentElement.style.setProperty('--header-bg', c);
        document.documentElement.style.setProperty('--panel-bg', '#fff');
        document.documentElement.style.setProperty('--footer-bg', c);

        document.documentElement.style.setProperty('--button-bg', c);
        document.documentElement.style.setProperty('--button-text', '#fff');

        document.documentElement.style.setProperty('--task-border', c);
        document.documentElement.style.setProperty('--arrow-color', c);

        document.documentElement.style.setProperty('--progress-fill', c);

        document.documentElement.style.setProperty('--text-color', c);

        document.querySelectorAll('.task-node, .planner-card').forEach(el => {
            el.style.borderColor = c;
        });

        document.querySelectorAll('.arrow').forEach(el => {
            el.style.backgroundColor = c;
        });

        document.querySelectorAll('button').forEach(el => {
            el.style.backgroundColor = c;
        });
    });

    function addTask(){
        const name=document.getElementById('taskName').value;
        const time=parseFloat(document.getElementById('taskTime').value);
        const diff=parseInt(document.getElementById('taskDifficulty').value);
        const due=new Date(document.getElementById('taskDue').value);
        if(!name||!time||!diff||!due) return alert('Fill all fields');
        tasks.push({name,time,diff,due,done:false});
        renderPlanner();
        updateProgress();
        document.getElementById('taskName').value='';
        document.getElementById('taskTime').value='';
        document.getElementById('taskDifficulty').value='';
        document.getElementById('taskDue').value='';
    }

    function updateProgress(){
        const doneTasks=tasks.filter(t=>t.done).reduce((sum,t)=>sum+t.time,0);
        const totalTime=tasks.reduce((sum,t)=>sum+t.time,0);
        const percent=totalTime? Math.min((doneTasks/totalTime)*100,100):0;
        progressFill.style.width=percent+'%';
    }

    function renderPlanner(){
        plannerBoard.innerHTML='';
        const now=new Date();
        const sorted=tasks.slice().sort((a,b)=>{
            const scoreA=(a.due-now)/36e5? 1/((a.due-now)/36e5):0;
            const scoreB=(b.due-now)/36e5? 1/((b.due-now)/36e5):0;
            return (scoreB+b.diff+b.time)-(scoreA+a.diff+a.time);
        });

        const row=document.createElement('div');
        row.className='flow-row';
        sorted.forEach((t,i)=>{
            const node=document.createElement('div');
            node.className='task-node'+(t.done?' done':'');
            node.innerHTML=`${t.name}<br>${t.time}h | D:${t.diff}`;
            node.onclick=()=>{
                t.done=!t.done;
                node.classList.toggle('done');
                updateProgress();
            };
            row.appendChild(node);
            if(i<sorted.length-1){
                const arrow=document.createElement('div');
                arrow.className='arrow';
                node.appendChild(arrow);
            }
        });
        plannerBoard.appendChild(row);
    }

    function startFocusMode(){
        const mins=parseInt(focusTimeInput.value);
        if(!mins || mins<1 || mins>60) return alert('Enter 1-60 minutes');
        if(focusInterval) clearInterval(focusInterval);

        focusStartTime=new Date();
        focusEndTime=new Date(focusStartTime.getTime() + mins*60*1000);

        focusInterval=setInterval(()=>{
            const now=new Date();
            let remaining=Math.floor((focusEndTime-now)/1000);
            if(remaining<=0){
                stopFocusMode();
                alert("Focus session complete!");
                return;
            }
            const m=Math.floor(remaining/60).toString().padStart(2,'0');
            const s=(remaining%60).toString().padStart(2,'0');
            focusDisplay.textContent=`Focus: ${formatTime(focusStartTime)} â†’ ${formatTime(focusEndTime)} | ${m}:${s} remaining`;
        },1000);
    }

    function stopFocusMode(){
    if(focusInterval) clearInterval(focusInterval);
    focusInterval=null;
    if(focusStartTime){
        const endTime=new Date();
        focusDisplay.textContent=`Focus session ended: ${formatTime(focusStartTime)} â†’ ${formatTime(endTime)}`;
        focusStartTime=null;
        focusEndTime=null;
    }
}

function formatTime(d){return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;}

async function generateAIPlanner(){
    if(!tasks.length) return alert("Add some tasks first!");

    const res = await fetch('http://localhost:3000/api/plan', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ tasks })
    });
    const data = await res.json();
    if(data.plan){
        tasks = data.plan;
        renderPlanner();
    } else {
        alert("Failed to generate AI plan");
    }
}

// Add a button
const aiBtn = document.createElement('button');
aiBtn.textContent = "AI Organize Planner";
aiBtn.onclick = generateAIPlanner;
document.querySelector('main').appendChild(aiBtn);
</script>
</body>
</html>