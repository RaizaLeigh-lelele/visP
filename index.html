<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flowchart Planner</title>
<link rel="stylesheet" href="planner.css">
</head>
<body>
    <header>
        <div class="nav-left">
            <a href="index.html">Home</a>
        </div>
        <div class="nav-right">
            <button id="musicToggle">ðŸŽµ</button>
            <button id="modeToggle">ðŸŒ™</button>
            <button id="colorToggle">ðŸŒˆ</button>
            <input type="color" id="colorPicker" value="#1E90FF" style="display:none;">
        </div>
    </header>
    <div class="mega-container">

    <main>
        <div class="panel">
            <h2>Add Task</h2>
            <input type="text" id="taskName" placeholder="Task Name">
            <input type="number" id="taskTime" placeholder="Time (hrs)" min="0.5" step="0.5">
            <input type="number" id="taskDifficulty" placeholder="Difficulty 1-10" min="1" max="10">
            <input type="datetime-local" id="taskDue">
            <button onclick="addTask()">Add Task</button>
        </div>

        <div class="panel">
            <h2>Progress</h2>
            <div class="progress-bar">
                <div id="progressFill" class="progress-bar-fill"></div>
            </div>

            <hr style="margin:20px 0; opacity:0.2;">

            <h2>Focus Mode</h2>
            <input type="number" id="focusTime" placeholder="Minutes (max 60)" min="1" max="60">
            <button onclick="startFocusMode()">Start Focus</button>
            <button onclick="stopFocusMode()">Stop Focus</button>
            <div class="focus-display" id="focusDisplay">No session running</div>
        </div>

        <div class="panel">
            <h2>Planner Board</h2>
            <button onclick="aiSortTasks()">AI Sort Tasks</button>
            <button onclick="suggestNextTask()">What should I do next?</button>
            <div id="aiSuggestion" style="margin-top:10px;font-weight:bold;"></div>
            <div id="plannerBoard"></div>
        </div>
</main>
</div>

<audio id="bgMusic" loop>
    <source src="h.mp3" type="audio/mpeg">
</audio>

<script>
const modeToggle = document.getElementById("modeToggle");
const colorToggle = document.getElementById("colorToggle");
const colorPicker = document.getElementById("colorPicker");

modeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
});

colorToggle.addEventListener("click", () => {
    colorPicker.style.display =
        colorPicker.style.display === "none" ? "inline-block" : "none";
});

let tasks = [];
const plannerBoard = document.getElementById('plannerBoard');
const progressFill = document.getElementById('progressFill');
const musicToggle = document.getElementById('musicToggle');
const bgMusic = document.getElementById('bgMusic');
const focusDisplay = document.getElementById('focusDisplay');
const focusTimeInput = document.getElementById('focusTime');

let isPlaying = false;
let focusInterval = null;
let focusEndTime = null;
let focusStartTime = null;

if (localStorage.getItem('tasks')) {
    tasks = JSON.parse(localStorage.getItem('tasks'));
    renderPlanner();
    updateProgress();
}

musicToggle.addEventListener('click', () => {
    if (isPlaying) { bgMusic.pause(); musicToggle.textContent = 'ðŸŽµ Music Off'; }
    else { bgMusic.play(); musicToggle.textContent = 'ðŸŽµ Music On'; }
    isPlaying = !isPlaying;
});

document.getElementById('colorPicker').addEventListener('input', e => {
    const c = e.target.value;
    document.documentElement.style.setProperty('--primary-color', c);
    document.documentElement.style.setProperty('--header-bg', c);
    document.documentElement.style.setProperty('--panel-bg', '#fff');
    document.documentElement.style.setProperty('--footer-bg', c);
    document.documentElement.style.setProperty('--button-bg', c);
    document.documentElement.style.setProperty('--button-text', '#fff');
    document.documentElement.style.setProperty('--task-border', c);
    document.documentElement.style.setProperty('--arrow-color', c);
    document.documentElement.style.setProperty('--progress-fill', c);
    document.documentElement.style.setProperty('--text-color', c);
});

function saveTasks() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
}

function addTask() {
    const name = document.getElementById('taskName').value;
    const time = parseFloat(document.getElementById('taskTime').value);
    const diff = parseInt(document.getElementById('taskDifficulty').value);
    const due = new Date(document.getElementById('taskDue').value);
    if (!name || !time || !diff || isNaN(due.getTime())) {
        return alert('Fill all fields');
    }

    
    tasks.push({ name, time, diff, due: due.toISOString(), done: false });
    saveTasks();
    aiSortTasks();
    updateProgress();
    
    document.getElementById('taskName').value = '';
    document.getElementById('taskTime').value = '';
    document.getElementById('taskDifficulty').value = '';
    document.getElementById('taskDue').value = '';
}

function updateProgress() {
    const doneTasks = tasks.filter(t => t.done).reduce((sum, t) => sum + t.time, 0);
    const totalTime = tasks.reduce((sum, t) => sum + t.time, 0);
    const percent = totalTime ? Math.min((doneTasks / totalTime) * 100, 100) : 0;
    progressFill.style.width = percent + '%';
}

function renderPlanner() {
    plannerBoard.innerHTML = '';

    const row = document.createElement('div');
    row.className = 'flow-row';

    tasks.forEach((t) => {
        const node = document.createElement('div');
        node.className = 'task-node' + (t.done ? ' done' : '');
        node.innerHTML = `${t.name}<br>${t.time}h | D:${t.diff}`;

        node.onclick = () => {
            t.done = !t.done;
            node.classList.toggle('done');
            updateProgress();
            saveTasks();
        };

        row.appendChild(node);
    });

    plannerBoard.appendChild(row);
}

function startFocusMode() {
    const mins = parseInt(focusTimeInput.value);
    if (!mins || mins < 1 || mins > 60) return alert('Enter 1-60 minutes');
    if (focusInterval) clearInterval(focusInterval);

    focusStartTime = new Date();
    focusEndTime = new Date(focusStartTime.getTime() + mins * 60 * 1000);

    focusInterval = setInterval(() => {
        const now = new Date();
        let remaining = Math.floor((focusEndTime - now) / 1000);
        if (remaining <= 0) {
            stopFocusMode();
            alert("Focus session complete!");
            return;
        }
        const m = Math.floor(remaining / 60).toString().padStart(2, '0');
        const s = (remaining % 60).toString().padStart(2, '0');
        focusDisplay.textContent = `Focus: ${formatTime(focusStartTime)} â†’ ${formatTime(focusEndTime)} | ${m}:${s} remaining`;
    }, 1000);
}

function stopFocusMode() {
    if (focusInterval) clearInterval(focusInterval);
    focusInterval = null;
    if (focusStartTime) {
        const endTime = new Date();
        focusDisplay.textContent = `Focus session ended: ${formatTime(focusStartTime)} â†’ ${formatTime(endTime)}`;
        focusStartTime = null;
        focusEndTime = null;
    }
}

function formatTime(d) {
    return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
}

function aiScore(task) {
    const now = new Date();
    const dueDate = new Date(task.due);

    const hoursLeft = (dueDate - now) / 36e5;

    const overduePenalty = hoursLeft < 0 ? Math.abs(hoursLeft) * 5 : 0;
    const urgencyScore = hoursLeft > 0 ? 1 / hoursLeft : 5;
    const difficultyScore = task.diff * 1.5;
    const timeScore = task.time;

    return (
        urgencyScore +
        difficultyScore +
        timeScore +
        overduePenalty
    );
}

function aiSortTasks() {
    tasks.sort((a, b) => aiScore(b) - aiScore(a));
    saveTasks();
    renderPlanner();
}

function suggestNextTask() {
    const pending = tasks.filter(t => !t.done);
    if (pending.length === 0) {
        document.getElementById('aiSuggestion').textContent =
            "ðŸŽ‰ All tasks completed!";
        return;
    }

    const best = pending.sort((a, b) => aiScore(b) - aiScore(a))[0];

    document.getElementById('aiSuggestion').textContent =
        `Do this next: "${best.name}" (${best.time}h, Difficulty ${best.diff})`;
}
</script>
</body>
</html>